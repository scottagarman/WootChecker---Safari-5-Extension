<!DOCTYPE html>
<html>
<head>
<title>global page</title>
<script type="text/javascript">
	//constants
	const TIME_5 = 5 * 60 * 1000;
	const TIME_1 = 1 * 60 * 1000; 
	const settings = safari.extension.settings;
	var updateInterval = (settings.interval != undefined && settings.interval >= 1) ? parseInt(settings.interval,10) : 30;
	alert("update Interval:  " + updateInterval);  
	var timer = undefined;
	
	function onLoad(){
		settings.addEventListener("change", intervalChanged, false);
	}
	
	function getFeed(){
	    alert("getting feed");
	    url = 'http://www.woot.com/salerss.aspx';
		xhr = new XMLHttpRequest();
    	xhr.open('GET', url, true);
        xhr.onreadystatechange = function (){
			if (xhr.readyState == 4 && xhr.status == 200) {
				//PARSE XML
	            try{
	                xml = xhr.responseXML;
					parse(xml);
				}catch(e){
	            }	
			}
			else if (xhr.readyState == 4 && xhr.status != 200) {
			}//end else if
		}// end onreadystatechange
		xhr.send(null);
	}
	function parse(xml){	
		data = {};
		data.itemName = xml.getElementsByTagName("title")[1].firstChild.nodeValue;
	    data.itemPrice = xml.getElementsByTagName("price")[0].firstChild.nodeValue;
	    data.desc = xml.getElementsByTagName("description")[1].firstChild.nodeValue;
	    data.teaser = xml.getElementsByTagName("teaser")[0].firstChild.nodeValue;
	    
	    data.comments = xml.getElementsByTagName("comments")[0].firstChild.nodeValue;
	    data.isSoldOut = xml.getElementsByTagName("soldout")[0].firstChild.nodeValue;
	    data.buyLink = xml.getElementsByTagName("purchaseurl")[0].firstChild.nodeValue;
	    data.chatLink = xml.getElementsByTagName("discussionurl")[0].firstChild.nodeValue;
	    data.isWootOff = xml.getElementsByTagName("wootoff")[0].firstChild.nodeValue;
	    
	    _updateBars(data);
	    
	    startTimer(data.isWootOff);  
	}
	
	function _updateBars(data){
	    var bars = safari.extension.bars;
	    for (var i = 0; i < bars.length; ++i) {
	        if (bars[i].identifier !== "woot_bar")
	            continue;
	        var barWindow = bars[i].contentWindow;
	        if (typeof barWindow.updateContent === "function")
	            barWindow.updateContent(data);
	    }
	}
	
	function startTimer(isWootOff){
		if(timer != undefined){
			clearTimeout(timer);
		}
		
		if(isWootOff == "True"){
			//short timer
			timer = setTimeout(getFeed, TIME_1);
		}else{
			//normal timer
			alert(updateInterval);
			timer = setTimeout(getFeed, updateInterval * 60 * 1000);
		}
	}
	
	function intervalChanged(event){
		if (event.key == "interval"){
		    updateInterval = parseInt(event.newValue,10);
	    }
	}
</script>
</head>
<body onload="onLoad();"></body>
</html>